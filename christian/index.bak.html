<!DOCTYPE html>
<html>
<head>

    <title>Labyrinth</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="view/css/style.css">  

    <script src="libraries/three.r68.js"></script>
    <script src="libraries/FpsControls.js"></script>
    <script src="libraries/Detector.js"></script>
    <script src="libraries/stats.min.js"></script>

</head>
<body>
                
    <div id="wrapper">
        <div id="instructions" style="">
            <span style="font-size:40px">Zum Spielen klicken!</span>
            <br /><br />
            (W, A, S, D = Gehen, SPACE = Springen, SHIFT = Rennen, MAUS = Umschauen)
        </div>
    </div>

    <script>
        
        var wrapper = document.getElementById("wrapper");
        
        var scene;
        var camera;
        var controls;
        var clock;
        var stats;
        var objects = [];
        var instructions = document.getElementById( 'instructions' );
        
        if(Detector.webgl){
            initControls();
            initGame();
            run();
        } else {
            alert('Leider wird WEBGL nicht unterst√ºtzt!');
        }

        function initGame(){
            
            /************/
            /* RENDERER */
            /************/
            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setClearColor(0xDDDDDD, 1);
            
            canvasWidth     = window.innerWidth - 10;
            canvasHeight    = window.innerHeight - 20;

            renderer.setSize(canvasWidth, canvasHeight);

            wrapper.appendChild(renderer.domElement);

            /*********/
            /* SCENE */
            /*********/
            scene = new THREE.Scene();
            
            /**********/
            /* CAMERA */
            /**********/
            camera = new THREE.PerspectiveCamera(45, canvasWidth / canvasHeight, 0.001, 1000);
            
            /************/
            /* CONTROLS */
            /************/
//            controls = new THREE.PointerLockControls( camera , scene);
//            scene.add( controls.getObject() );
            
            controls = new FpsControls({
                camera: camera,
                debug: false,
                collidables: objects,
                fly: false,
                xCollisionHeights: [1.8, 1.3, 0.8, 0.5, 0.3],
                xCollisionCrouchHeights: [0.8, 0.4, 0.3],
                crouchHeight: 0.8,
                normalSpeed: 80,
                sprintSpeed: 150,
                cameraHeight: 1.8,
                cameraStartPosition: {y: 1.8, x: 0, z:6},
            });
            scene.add( controls.getObject() );
            
            /*********/
            /* CLOCK */
            /*********/
            clock = new THREE.Clock(true);
            
            /*********/
            /* STATS */
            /*********/
            stats = new Stats();
            wrapper.appendChild( stats.domElement );
            
            /***********/
            /* CONTENT */
            /***********/
            
            // floor
            var geometry = new THREE.PlaneGeometry( 40, 40 ); 
            var texture = new THREE.ImageUtils.loadTexture("view/images/floor.jpg");
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping; 
            texture.repeat.set( 40, 40 );
            
            var material = new THREE.MeshLambertMaterial( {
                map:  texture, 
                side: THREE.DoubleSide
            }); 
            
            
            var ceiling = new THREE.Mesh( geometry, material ); 
            ceiling.rotation.set(Math.PI / 2, 0.0, 0.0);
            ceiling.position.set(0.0, 5.0, 0.0);
            scene.add( ceiling );
            objects.push( ceiling );
            
            var floor = new THREE.Mesh( geometry, material ); 
            floor.rotation.set(Math.PI / 2, 0.0, 0.0);
            floor.position.set(0.0, 0.0, 0.0);
            scene.add( floor );
            objects.push( floor );
            
            
            // boxes
            var boxGeometry = new THREE.BoxGeometry(1.0, 1.0, 1.0);
            var crateTexture = new THREE.ImageUtils.loadTexture("view/images/crate.jpg");
            var boxMaterial = new THREE.MeshLambertMaterial({ map:crateTexture });
            
            addBox(new THREE.Vector3(-1.0,0.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(0.0,0.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(1.0,0.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(2.0,0.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(4.0,0.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(5.0,0.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(6.0,0.5, -3.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-1.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(0.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(1.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(2.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(4.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(5.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(6.0,1.5, -3.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-1.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(0.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(1.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(2.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(3.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(4.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(5.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(6.0,2.5, -3.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-1.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(0.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(1.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(2.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(3.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(4.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(5.0,3.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(6.0,3.5, -3.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(7.0,2.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(8.0,1.5, -3.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(9.0,0.5, -3.0), boxGeometry, boxMaterial);
            
            
            addBox(new THREE.Vector3(8.0,-0.4, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(8.0,-0.4, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(7.0,-0.31, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(7.0,-0.31, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(6.0,-0.22, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(6.0,-0.22, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(5.0,-0.13, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(5.0,-0.13, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(4.0,-0.04, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(4.0,-0.04, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(3.0,0.05, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(3.0,0.05, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(2.0,0.14, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(2.0,0.14, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(1.0,0.23, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(1.0,0.23, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(0.0,0.32, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(0.0,0.32, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-1.0,0.41, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-1.0,0.41, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-2.0,0.5, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-2.0,0.5, 8.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-3.0,0.59, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-3.0,0.59, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-3.0,-0.41, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-3.0,-0.41, 8.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-4.0,0.68, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-4.0,0.68, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-4.0,-0.32, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-4.0,-0.32, 8.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-5.0,0.77, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-5.0,0.77, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-5.0,-0.23, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-5.0,-0.23, 8.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-6.0,0.86, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-6.0,0.86, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-6.0,-0.14, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-6.0,-0.14, 8.0), boxGeometry, boxMaterial);
            
            addBox(new THREE.Vector3(-7.0,0.95, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-7.0,0.95, 8.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-7.0,-0.05, 7.0), boxGeometry, boxMaterial);
            addBox(new THREE.Vector3(-7.0,-0.05, 8.0), boxGeometry, boxMaterial);
            

        
            /**********/
            /* LIGHTS */
            /**********/
            var ambientLight = new THREE.AmbientLight(0xffffff);
            scene.add(ambientLight);
            
            window.addEventListener( 'resize', onWindowResize, false );
            
        }

        function run(){
            
            requestAnimationFrame(run);
            
//            controls.update(objects, clock.getDelta());
            controls.update();
            
            stats.update();
            
            render();
            
        }

        function render(){
            renderer.render(scene, camera);
        }
        
        function initControls(){
            
            var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

            if ( havePointerLock ) {

                var element = document.body;

                var pointerlockchange = function ( event ) {
                    if ( document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element ) {
                        controls.activateControls();
                        instructions.style.display = 'none';

                    } else {
                        controls.deactivateControls();
                        instructions.style.display = '';
                    }
                }

                var pointerlockerror = function ( event ) {
                    instructions.style.display = '';
                }

                // Hook pointer lock state change events
                document.addEventListener( 'pointerlockchange', pointerlockchange, false );
                document.addEventListener( 'mozpointerlockchange', pointerlockchange, false );
                document.addEventListener( 'webkitpointerlockchange', pointerlockchange, false );

                document.addEventListener( 'pointerlockerror', pointerlockerror, false );
                document.addEventListener( 'mozpointerlockerror', pointerlockerror, false );
                document.addEventListener( 'webkitpointerlockerror', pointerlockerror, false );

                instructions.addEventListener( 'click', function ( event ) {

                    instructions.style.display = 'none';

                    // Ask the browser to lock the pointer
                    element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

                    if ( /Firefox/i.test( navigator.userAgent ) ) {

                        var fullscreenchange = function ( event ) {

                            if ( document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element ) {

                                document.removeEventListener( 'fullscreenchange', fullscreenchange );
                                document.removeEventListener( 'mozfullscreenchange', fullscreenchange );

                                element.requestPointerLock();
                            }

                        }

                        document.addEventListener( 'fullscreenchange', fullscreenchange, false );
                        document.addEventListener( 'mozfullscreenchange', fullscreenchange, false );

                        element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

                        element.requestFullscreen();

                    } 
                    else {

                        element.requestPointerLock();

                    }
                }, false );
            } else {
                instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API<br /><br />PLAYING NOT POSSIBLE!';
            }
            
        }
        
        function onWindowResize() {

            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize( window.innerWidth, window.innerHeight );

        }
        
        function addBox(position, geometry, material){
            
            var boxMesh = new THREE.Mesh(geometry, material);
            boxMesh.position.set(position.x, position.y, position.z);
            boxMesh.doubleSided = true;
            scene.add(boxMesh);
            objects.push( boxMesh );
            
        }
        
    </script>
    
</body>
</html>
